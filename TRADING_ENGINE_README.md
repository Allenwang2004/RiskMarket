# Risk Market 交易引擎更新

## 🎯 更新內容

我已經按照您的需求修改了系統，現在**下單時不會直接成交，而是送給後端搓合引擎進行撮合**。只有確定撮合成功後，才會顯示成交訊息。

## 🏗️ 新的系統架構

### 後端交易引擎 (Backend Trading Engine)
- **位置**: `/backend/`
- **端口**: 3001
- **功能**:
  - 訂單簿管理
  - 自動撮合算法
  - WebSocket 實時通知
  - RESTful API

### 前端應用 (Frontend)
- **位置**: `/frontend/`
- **端口**: 3000
- **功能**:
  - 錢包連接 (MetaMask)
  - 下單界面
  - 實時訂單簿顯示
  - 撮合結果通知

## 🔄 新的交易流程

1. **用戶下單** → 前端發送到後端搓合引擎
2. **後端搓合** → 自動尋找匹配的對手方訂單
3. **撮合成功** → 通過 WebSocket 即時通知所有用戶
4. **更新顯示** → 前端更新訂單簿和用戶資產

## 🚀 快速開始

### 方法一：使用一鍵啟動腳本
```bash
# 在專案根目錄執行
./start.sh
```

### 方法二：分別啟動
```bash
# 終端 1：啟動後端交易引擎
cd backend
npm install
npm run dev

# 終端 2：啟動前端應用
cd frontend
npm install  
npm run dev
```

## 📋 主要改進

### 1. 後端搓合引擎
- **訂單管理**: 支援買單/賣單的自動排序和匹配
- **撮合算法**: 價格優先，時間優先的撮合邏輯
- **實時通知**: WebSocket 推送撮合結果

### 2. 前端優化
- **異步下單**: 訂單提交後不阻塞界面
- **實時更新**: 接收後端推送的撮合結果
- **狀態管理**: 顯示訂單狀態（待撮合、已撮合、已取消）

### 3. 用戶體驗
- **即時反饋**: 下單後立即顯示"訂單已提交"
- **撮合通知**: 成功撮合時顯示"恭喜！您的訂單已成功撮合"
- **訂單追蹤**: 可查看和取消待撮合的訂單

## 🔧 技術細節

### API 端點
- `POST /api/orders` - 提交訂單
- `DELETE /api/orders/:id` - 取消訂單
- `GET /api/orderbook/:tokenType` - 獲取訂單簿
- `GET /api/orders/user/:address` - 獲取用戶訂單
- `GET /api/market-price/:tokenType` - 獲取市場價格

### WebSocket 訊息
- `order_submitted` - 訂單已提交
- `order_matched` - 訂單撮合成功
- `order_cancelled` - 訂單已取消
- `orderbook_update` - 訂單簿更新

## 🎮 使用說明

1. **連接錢包**: 點擊"連接 MetaMask 錢包"
2. **選擇操作**: 選擇買入/賣出，選擇 YES/NO token
3. **輸入訂單**: 填寫價格和數量
4. **提交訂單**: 點擊下單按鈕
5. **等待撮合**: 系統會自動尋找匹配的對手方
6. **接收通知**: 撮合成功時會收到通知

## 📊 訊息類型

- **藍色訊息**: 系統狀態（連接、載入等）
- **綠色訊息**: 成功操作（訂單提交、撮合成功等）
- **紅色訊息**: 錯誤或失敗
- **黃色訊息**: 載入中狀態

## 🛠️ 開發說明

### 後端結構
```
backend/
├── src/
│   ├── server.ts      # 主服務器
│   ├── orderbook.ts   # 訂單簿邏輯
│   └── types.ts       # 類型定義
├── package.json
└── tsconfig.json
```

### 撮合邏輯
- **買單**: 按價格從高到低排序
- **賣單**: 按價格從低到高排序
- **撮合條件**: 買單價格 ≥ 賣單價格
- **成交價格**: 使用先掛單方的價格

這樣的設計確保了：
1. 🎯 **訂單不會直接成交** - 需要通過搓合引擎
2. 📈 **公平的價格發現** - 市場機制決定成交價
3. ⚡ **實時反饋** - 用戶即時了解訂單狀態
4. 🔒 **安全可靠** - 後端統一管理所有訂單
